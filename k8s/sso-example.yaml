# ðŸ” Exemple complet de configuration SSO avec Keycloak
# Ce fichier montre comment configurer l'authentification SSO

---
# ConfigMap pour la configuration SSO (partie publique)
apiVersion: v1
kind: ConfigMap
metadata:
  name: sso-config
  namespace: notes-app
data:
  # ðŸŒ URLs publiques Keycloak
  SSO_PROVIDER: "keycloak"
  SSO_REALM: "notes-realm"
  SSO_URL: "https://keycloak.example.com"
  SSO_AUTH_URL: "https://keycloak.example.com/realms/notes-realm/protocol/openid-connect/auth"
  SSO_TOKEN_URL: "https://keycloak.example.com/realms/notes-realm/protocol/openid-connect/token"
  SSO_USERINFO_URL: "https://keycloak.example.com/realms/notes-realm/protocol/openid-connect/userinfo"
  
  # ðŸ”— OAuth Configuration
  OAUTH_SCOPES: "openid profile email"
  OAUTH_RESPONSE_TYPE: "code"
  OAUTH_GRANT_TYPE: "authorization_code"
  
  # ðŸ”™ Redirect URLs
  OAUTH_REDIRECT_URI: "https://notes-app.example.com/callback"
  OAUTH_LOGOUT_REDIRECT: "https://notes-app.example.com"

---
# Secret pour les credentials SSO (partie sensible)
apiVersion: v1
kind: Secret
metadata:
  name: sso-secrets
  namespace: notes-app
type: Opaque
data:
  # ðŸ”’ Keycloak Client Credentials
  # Client ID: notes-app-client
  KEYCLOAK_CLIENT_ID: bm90ZXMtYXBwLWNsaWVudA==
  
  # Client Secret: abc123def456ghi789jkl
  KEYCLOAK_CLIENT_SECRET: YWJjMTIzZGVmNDU2Z2hpNzg5amts
  
  # ðŸ” Google OAuth (si vous utilisez Google SSO)
  # GOOGLE_CLIENT_ID: MTIzNDU2Nzg5MC5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbQ==
  # GOOGLE_CLIENT_SECRET: R09DU1BYLWFiY2RlZmdoaWprbG1ub3A=
  
  # ðŸ” Microsoft Azure AD (si vous utilisez Azure SSO)
  # AZURE_CLIENT_ID: YXp1cmUtY2xpZW50LWlkLTEyMzQ1Ng==
  # AZURE_CLIENT_SECRET: YXp1cmUtY2xpZW50LXNlY3JldC1hYmNkZWY=
  # AZURE_TENANT_ID: dGVuYW50LWlkLWFiY2RlZi0xMjM0NTY=

---
# Deployment avec SSO configurÃ©
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-with-sso
  namespace: notes-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend-sso
  template:
    metadata:
      labels:
        app: backend-sso
    spec:
      containers:
        - name: backend
          image: ton-dockerhub-username/notes-backend:latest
          ports:
            - containerPort: 8000
          env:
            # Variables depuis ConfigMap (publiques)
            - name: SSO_PROVIDER
              valueFrom:
                configMapKeyRef:
                  name: sso-config
                  key: SSO_PROVIDER
            - name: SSO_REALM
              valueFrom:
                configMapKeyRef:
                  name: sso-config
                  key: SSO_REALM
            - name: SSO_URL
              valueFrom:
                configMapKeyRef:
                  name: sso-config
                  key: SSO_URL
            - name: OAUTH_SCOPES
              valueFrom:
                configMapKeyRef:
                  name: sso-config
                  key: OAUTH_SCOPES
            
            # Variables depuis Secret (sensibles)
            - name: KEYCLOAK_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: sso-secrets
                  key: KEYCLOAK_CLIENT_ID
            - name: KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: sso-secrets
                  key: KEYCLOAK_CLIENT_SECRET

---
# ðŸ“ EXPLICATION DES CONCEPTS SSO

# 1ï¸âƒ£ QU'EST-CE QU'UN REALM ?
# Un Realm est comme un "royaume" ou "domaine" de sÃ©curitÃ©.
# Dans Keycloak, c'est un espace isolÃ© qui contient :
#   - Utilisateurs (alice@example.com, bob@example.com)
#   - Applications/Clients (notes-app, dashboard-app)
#   - RÃ´les (admin, user, viewer)
#   - Groupes (developers, managers)

# Exemple de structure :
# Realm: "notes-realm"
#   â”œâ”€â”€ Users
#   â”‚   â”œâ”€â”€ alice@example.com (role: admin)
#   â”‚   â”œâ”€â”€ bob@example.com (role: user)
#   â”‚   â””â”€â”€ charlie@example.com (role: viewer)
#   â”œâ”€â”€ Clients
#   â”‚   â”œâ”€â”€ notes-app (votre application)
#   â”‚   â”œâ”€â”€ admin-dashboard
#   â”‚   â””â”€â”€ mobile-app
#   â””â”€â”€ Roles
#       â”œâ”€â”€ admin (full access)
#       â”œâ”€â”€ user (read/write notes)
#       â””â”€â”€ viewer (read only)

# 2ï¸âƒ£ COMMENT FONCTIONNE SSO ?

# Flux d'authentification OAuth2/OIDC :
# 
# Utilisateur                Frontend              Backend              Keycloak
#    |                          |                      |                     |
#    |--1. Clique "Login"------>|                      |                     |
#    |                          |---2. Redirect------->|                     |
#    |                          |                      |                     |
#    |<-----------3. Redirect vers page de login Keycloak------------------|
#    |                          |                      |                     |
#    |----4. Entre credentials (email/password)----------------------->|
#    |                          |                      |                     |
#    |<-----------5. Redirect avec code d'autorisation------------------|
#    |                          |                      |                     |
#    |--6. Envoie code--------->|                      |                     |
#    |                          |--7. Code + Client Secret-------->|         |
#    |                          |                      |                     |
#    |                          |<-8. Access Token + Refresh Token-----------|
#    |                          |                      |                     |
#    |<-9. Session crÃ©Ã©e--------|                      |                     |
#    |                          |                      |                     |
#    |--10. API request-------->|--11. Token----------->|                    |
#    |                          |                      |--12. Valide token-->|
#    |                          |                      |<-13. User info------|
#    |<-14. Response------------|<-15. Data------------|                     |

# 3ï¸âƒ£ POURQUOI SÃ‰PARER CLIENT_ID (public) et CLIENT_SECRET (secret) ?

# CLIENT_ID (Public - dans ConfigMap)
#   - Identifie votre application
#   - Visible dans l'URL du navigateur
#   - Peut Ãªtre public
#   - Exemple: "notes-app-client"

# CLIENT_SECRET (Sensible - dans Secret)
#   - Prouve que vous Ãªtes vraiment l'application
#   - NE DOIT JAMAIS Ãªtre exposÃ© au frontend
#   - Comme un mot de passe pour votre app
#   - UtilisÃ© uniquement cÃ´tÃ© backend
#   - Exemple: "abc123def456ghi789jkl"

# 4ï¸âƒ£ EXEMPLE CONCRET

# Imaginez :
# - Vous crÃ©ez une app "Notes App"
# - Vous voulez que les employÃ©s de votre entreprise se connectent
# - Vous utilisez Keycloak comme serveur SSO

# Configuration dans Keycloak :
# 1. CrÃ©er un Realm : "mon-entreprise"
# 2. CrÃ©er un Client : "notes-app"
# 3. Keycloak gÃ©nÃ¨re un CLIENT_SECRET : "secret-abc-123"
# 4. Configurer les URLs de redirect : "https://notes.com/callback"

# Dans votre app Kubernetes :
# ConfigMap â†’ CLIENT_ID (public)
# Secret â†’ CLIENT_SECRET (sensible)

# Quand un utilisateur se connecte :
# 1. Il voit la page Keycloak
# 2. Entre son email/password
# 3. Keycloak valide
# 4. Retourne un token Ã  votre app
# 5. Votre app utilise ce token pour savoir qui est l'utilisateur

# 5ï¸âƒ£ AVANTAGES DU SSO

# âœ… Un seul login pour toutes les apps
# âœ… Gestion centralisÃ©e des utilisateurs
# âœ… SÃ©curitÃ© renforcÃ©e (2FA, politiques de mot de passe)
# âœ… Audit centralisÃ© (qui s'est connectÃ© quand)
# âœ… RÃ©vocation facile (bloquer un utilisateur partout)
