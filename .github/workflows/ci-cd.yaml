name: üöÄ CI-CD Pipeline (Docker + Kubernetes + ArgoCD)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-push-update:
    runs-on: ubuntu-latest
    
    env:
      IMAGE_BACKEND: ${{ secrets.DOCKERHUB_USERNAME }}/notes-backend
      IMAGE_FRONTEND: ${{ secrets.DOCKERHUB_USERNAME }}/notes-frontend
      BRANCH: main   

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîß Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      # ====== BACKEND ======
      - name: üêç Build & Push Backend
        id: backend_build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.IMAGE_BACKEND }}:latest
            ${{ env.IMAGE_BACKEND }}:${{ github.sha }}

      # ====== FRONTEND ======
      
      - name: üåê Build & Push Frontend
        id: frontend_build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.IMAGE_FRONTEND }}:latest
            ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}

      # ====== UPDATE K8S FILES ======
      - name: üìù Mise √† jour des images dans les YAML K8s
        run: |
          echo "üîÑ Mise √† jour des images Docker dans les fichiers YAML..."
          sed -i "s#${{ env.IMAGE_BACKEND }}:.*#${{ env.IMAGE_BACKEND }}:${{ github.sha }}#g" k8s/deployment-backend.yaml
          sed -i "s#${{ env.IMAGE_FRONTEND }}:.*#${{ env.IMAGE_FRONTEND }}:${{ github.sha }}#g" k8s/deployment-frontend.yaml

      # ====== COMMIT YAML CHANGES ======
      - name: üíæ Commit & Push modifications YAML
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add k8s/deployment-backend.yaml k8s/deployment-frontend.yaml
          git commit -m "üîÑ Update Docker images to ${{ github.sha }}" || echo "No changes to commit"
          git push origin ${{ env.BRANCH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ====== LOGS ======
      - name: ‚úÖ Fin du pipeline
        run: |
          echo "-----------------------------------"
          echo "‚úÖ Pipeline termin√© avec succ√®s !"
          echo "Les images suivantes ont √©t√© d√©ploy√©es :"
          echo " - Backend : ${{ env.IMAGE_BACKEND }}:${{ github.sha }}"
          echo " - Frontend: ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}"
          echo "-----------------------------------"
